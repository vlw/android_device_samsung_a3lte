/*
 * Copyright (C) 2019-2020 Vladimir Bely <vlwwwwww@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#define LOG_TAG "audio_hw_amplifier_tfa"
#define LOG_NDEBUG 0

#include <cutils/log.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <errno.h>
#include <dlfcn.h>
#include <fcntl.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#include <tinyalsa/asoundlib.h>
#include <linux/i2c.h>
#include <linux/i2c-dev.h>
#include <linux/input.h>

#include "tfa.h"
#include "tfa_cmd.h"

#define SND_CARD        0
#define AMP_PCM_DEV     0
#define AMP_MIXER_CTL   "QUAT_MI2S_RX Audio Mixer MultiMedia1"

#define TFA_DEV "/dev/i2c-1"
#define TFA_ADDR 0x34

static struct pcm_config amp_pcm_config = {
    .channels = 2, 
    .rate = 48000,
    .period_size = 256,
    .period_count = 2,
    .format = PCM_FORMAT_S16_LE,
    .start_threshold = 256 * 2 - 1,
    .stop_threshold = UINT_MAX,
    .silence_threshold = 0,
    .avail_min = 1,
};

static int tfa_clock_on(tfa_device_t *tfa_dev)
{
    struct mixer_ctl *ctl;
//    struct pcm_params *pcm_params;
    uint8_t *buffer;
    int size;

    if (tfa_dev->clock_enabled) {
        ALOGI("TFA clocks is already enabled!");
        return 0;
    }

    ctl = mixer_get_ctl_by_name(tfa_dev->mixer, AMP_MIXER_CTL);
    if (ctl == NULL) {
        ALOGE("%s: Could not find %s", __func__, AMP_MIXER_CTL);
        return -ENODEV;
    }
/*
    pcm_params = pcm_params_get(SND_CARD, AMP_PCM_DEV, PCM_OUT);
    if (pcm_params == NULL) {
        ALOGE("Could not get the pcm_params");
        return -EIO;
    }

    amp_pcm_config.period_count = pcm_params_get_max(pcm_params, PCM_PARAM_PERIODS);
    pcm_params_free(pcm_params);
*/
    mixer_ctl_set_value(ctl, 0, 1);

    tfa_dev->pcm = pcm_open(SND_CARD, AMP_PCM_DEV, PCM_OUT | PCM_MONOTONIC, &amp_pcm_config);
    if (!tfa_dev->pcm) {
        ALOGE("Failed to open pcm! (incorrect parameters?)");
        return -EPERM;
    }
    if (!pcm_is_ready(tfa_dev->pcm)) {
        ALOGE("Failed to open pcm device: %s", pcm_get_error(tfa_dev->pcm));
        pcm_close(tfa_dev->pcm);
        return -EBUSY;
    }

    size = 1024 * 8;
    buffer = calloc(1, size);
    if (!buffer) {
        ALOGE("%s: failed to allocate buffer", __func__);
        pcm_close(tfa_dev->pcm);
        return -EBUSY;
    }

    if (pcm_write(tfa_dev->pcm, buffer, size)) {
        ALOGE("%s: pcm_write failed", __func__);
    }

    tfa_dev->clock_enabled = true;

    ALOGW("%s: clocks enabled", __func__);

    return 0;
}

static int tfa_clock_off(tfa_device_t *tfa_dev)
{
    struct mixer_ctl *ctl;

    if (!tfa_dev->clock_enabled) {
        ALOGI("TFA clocks is already disabled!");
        return 0;
    }

    pcm_close(tfa_dev->pcm);

    usleep(100000); //0.1s

    ctl = mixer_get_ctl_by_name(tfa_dev->mixer, AMP_MIXER_CTL);
    if (ctl == NULL) {
        ALOGE("%s: Could not find %s", __func__, AMP_MIXER_CTL);
        return -ENODEV;
    } else {
        mixer_ctl_set_value(ctl, 0, 0);
    }

    tfa_dev->clock_enabled = false;

    ALOGI("%s: clocks disabled", __func__);

    return 0;
}

int i2c_write(tfa_device_t *tfa_dev, unsigned char buf[], int count)
{
    ioctl(tfa_dev->fd, I2C_SLAVE, TFA_ADDR);

    return write(tfa_dev->fd, buf, count+1);
}

int i2c_read(tfa_device_t *tfa_dev, unsigned char reg, unsigned char *buf, int count)
{
    ioctl(tfa_dev->fd, I2C_SLAVE, TFA_ADDR);

    write(tfa_dev->fd, &reg, 1);
    
    return read(tfa_dev->fd, buf, count);
}

int tfa_status_read(tfa_device_t *tfa_dev)
{
    i2c_read(tfa_dev, 0x00, tfa_dev->status.flag, 2);

    tfa_dev->status.flag_power = (bool)(tfa_dev->status.flag[1]&0x1);
    tfa_dev->status.flag_pll_lock = (bool)(tfa_dev->status.flag[1]&0x2);
    tfa_dev->status.flag_otp_ok = (bool)(tfa_dev->status.flag[1]&0x4);
    tfa_dev->status.flag_ovp_ok = (bool)(tfa_dev->status.flag[1]&0x8);
    tfa_dev->status.flag_uvp_ok = (bool)(tfa_dev->status.flag[1]&0x10);
    tfa_dev->status.flag_ocp_alarm = (bool)(tfa_dev->status.flag[1]&0x20);
    tfa_dev->status.flag_clocks_stable = (bool)(tfa_dev->status.flag[1]&0x40);
    tfa_dev->status.flag_clip = (bool)(tfa_dev->status.flag[1]&0x80);
    tfa_dev->status.flag_mtp_busy = (bool)(tfa_dev->status.flag[0]&0x1);
    tfa_dev->status.flag_power_ok_bst = (bool)(tfa_dev->status.flag[0]&0x2);
    tfa_dev->status.flag_cf_spk_error = (bool)(tfa_dev->status.flag[0]&0x4);
    tfa_dev->status.flag_cold_started = (bool)(tfa_dev->status.flag[0]&0x8);
    tfa_dev->status.flag_sws = (bool)(tfa_dev->status.flag[0]&0x10);
    tfa_dev->status.flag_watchdog_reset = (bool)(tfa_dev->status.flag[0]&0x20);
    tfa_dev->status.flag_enable_amp = (bool)(tfa_dev->status.flag[0]&0x40);
    tfa_dev->status.flag_enable_ref = (bool)(tfa_dev->status.flag[0]&0x80);

    return 0;
}

void tfa_status_log(tfa_device_t *tfa_dev)
{
    ALOGI(" [STATUS] Current TFA status is: 0x%02X%02X", tfa_dev->status.flag[0], tfa_dev->status.flag[1]);
    ALOGI(" [STATUS] Stable power in: %s", tfa_dev->status.flag_power ? "+" : "-");
    ALOGI(" [STATUS] PLL_lock: %s", tfa_dev->status.flag_pll_lock ? "+" : "-");
    ALOGI(" [STATUS] OTP voltage: %s", tfa_dev->status.flag_otp_ok ? "+" : "-");
    ALOGI(" [STATUS] OVP voltage: %s", tfa_dev->status.flag_ovp_ok ? "+" : "-");
    ALOGI(" [STATUS] UVP voltage: %s", tfa_dev->status.flag_uvp_ok ? "+" : "-");
    ALOGI(" [STATUS] OCP alarm: %s", tfa_dev->status.flag_ocp_alarm ? "+" : "-");
    ALOGI(" [STATUS] Stable clocks (DSP): %s", tfa_dev->status.flag_clocks_stable ? "+" : "-");
    ALOGI(" [STATUS] CLIP: %s", tfa_dev->status.flag_clip ? "+" : "-");
    ALOGI(" [STATUS] MTP busy: %s", tfa_dev->status.flag_mtp_busy ? "+" : "-");
    ALOGI(" [STATUS] Power bst: %s", tfa_dev->status.flag_power_ok_bst ? "+" : "-");
    ALOGI(" [STATUS] CoolFlux speaker error: %s", tfa_dev->status.flag_cf_spk_error ? "+" : "-");
    ALOGI(" [STATUS] Cold started: %s", tfa_dev->status.flag_cold_started ? "+" : "-");
    ALOGI(" [STATUS] SWS (In engage): %s", tfa_dev->status.flag_sws ? "+" : "-");
    ALOGI(" [STATUS] Watchdog reset: %s", tfa_dev->status.flag_watchdog_reset ? "+" : "-");
    ALOGI(" [STATUS] Amplifier enabled: %s", tfa_dev->status.flag_enable_amp ? "+" : "-");
    ALOGI(" [STATUS] Ref enabled: %s", tfa_dev->status.flag_enable_ref ? "+" : "-");

    return;
}

int tfa_control_read(tfa_device_t *tfa_dev)
{
    i2c_read(tfa_dev, 0x09, tfa_dev->control.flag, 2);

    tfa_dev->control.flag_powerdown = (bool)(tfa_dev->control.flag[1]&0x1);
    tfa_dev->control.flag_reset = (bool)(tfa_dev->control.flag[1]&0x2);
    tfa_dev->control.flag_enable_cf = (bool)(tfa_dev->control.flag[1]&0x4);
    tfa_dev->control.flag_enable_amp = (bool)(tfa_dev->control.flag[1]&0x8);
    tfa_dev->control.flag_enable_boost = (bool)(tfa_dev->control.flag[1]&0x10);
    tfa_dev->control.flag_cf_configured = (bool)(tfa_dev->control.flag[1]&0x20);
    tfa_dev->control.flag_amp_configured = (bool)(tfa_dev->control.flag[1]&0x40);
    tfa_dev->control.flag_dcdcoff = (bool)(tfa_dev->control.flag[1]&0x80);

    return 0;
}

void tfa_control_log(tfa_device_t *tfa_dev)
{
    ALOGI(" [CONTROL] Current TFA control reg is: 0x%02X%02X", tfa_dev->control.flag[0], tfa_dev->control.flag[1]);
    ALOGI(" [CONTROL] Manual power down: %s", tfa_dev->control.flag_powerdown ? "+" : "-");
    ALOGI(" [CONTROL] Manual reset: %s", tfa_dev->control.flag_reset ? "+" : "-");
    ALOGI(" [CONTROL] Enable CoolFlux Engine: %s", tfa_dev->control.flag_enable_cf ? "+" : "-");
    ALOGI(" [CONTROL] Enable Amplifier: %s", tfa_dev->control.flag_enable_amp ? "+" : "-");
    ALOGI(" [CONTROL] Enable Boost: %s", tfa_dev->control.flag_enable_boost ? "+" : "-");
    ALOGI(" [CONTROL] CoolFlux is configured: %s", tfa_dev->control.flag_cf_configured ? "+" : "-");
    ALOGI(" [CONTROL] Amplifier is configured: %s", tfa_dev->control.flag_amp_configured ? "+" : "-");
    ALOGI(" [CONTROL] DCDC off mode: %s", tfa_dev->control.flag_dcdcoff ? "+" : "-");

    return;
}

int tfa_control_set(tfa_device_t *tfa_dev)
{
    tfa_dev->control.flag[1] = 0x0;

    tfa_dev->control.flag[1] |= 0x1 * tfa_dev->control.flag_powerdown;
    tfa_dev->control.flag[1] |= 0x2 * tfa_dev->control.flag_reset;
    tfa_dev->control.flag[1] |= 0x4 * tfa_dev->control.flag_enable_cf;
    tfa_dev->control.flag[1] |= 0x8 * tfa_dev->control.flag_enable_amp;
    tfa_dev->control.flag[1] |= 0x10 * tfa_dev->control.flag_enable_boost;
    tfa_dev->control.flag[1] |= 0x20 * tfa_dev->control.flag_cf_configured;
    tfa_dev->control.flag[1] |= 0x40 * tfa_dev->control.flag_amp_configured;
    tfa_dev->control.flag[1] |= 0x80 * tfa_dev->control.flag_dcdcoff;

    i2c_write(tfa_dev, (unsigned char []){0x09, tfa_dev->control.flag[0], tfa_dev->control.flag[1]}, 2);

    return 0;
}

int tfa_mem_done(tfa_device_t *tfa_dev)
{
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x01, 0x12}, 2);
    i2c_read(tfa_dev, 0x73, NULL, 2); //01 00
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02, 0x00, 0x00}, 4);
    i2c_read(tfa_dev, 0x72, NULL, 3);
    return 0;
}

int tfa_preset_write(tfa_device_t *tfa_dev, int num)
{
    switch (num){
        case 1: //speaker_default

            i2c_write(tfa_dev, MEM_PRESET, 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x01, 0x00, 0x00, 0xe6, 0x00, 0x00, 
            0x02, 0x00, 0x80, 0x00, 0x00, 0x05, 0xaa, 0x00, 0x00, 0x00, 0x00, 0x01, 0x2c, 0x01, 0x47, 
            0xae, 0x00, 0x2b, 0xb0, 0x00, 0x00, 0xd2, 0x00, 0x1a, 0x37, 0x01, 0x00, 0x00, 0x04, 0x00, 
            0x00, 0x07, 0x00, 0x00, 0x05, 0x99, 0x9a, 0x08, 0x7a, 0xe1, 0x01, 0x66, 0x66, 0x01, 0x00, 
            0x00, 0x00, 0x0c, 0xcd, 0x00, 0x40, 0x00, 0x00, 0x01, 0x48, 0x00, 0x02, 0x8f, 0x01, 0x00, 
            0x00, 0x00, 0x01, 0x89, 0x00, 0x01, 0x48, 0x05, 0xc2, 0x8f, 0x08, 0x7a, 0xe1, 0x00, 0x1a, 
            0xe1, 0x00, 0x00, 0x14}, 87);
            tfa_mem_done(tfa_dev);
            break;
        case 2: 
            break;
        case 3:
            break;
    }

    switch (num){
        case 1: 
        case 2://any speaker amp level

            i2c_write(tfa_dev, MEM_DSP_PARAM[0], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7a, 0x96, 
                                     0x3d, 0x00, 0x00, 0x00, 0xe0, 0x87, 0x19, 0x1f, 0x78, 0xe7}, 18);
            tfa_mem_done(tfa_dev);

            i2c_write(tfa_dev, MEM_DSP_PARAM[1], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x01, 0xc3, 0x10, 0xd3, 0x7c, 0xdb, 
                                    0x34, 0x3e, 0x72, 0x98, 0x83, 0x1a, 0xcf, 0x3e, 0x72, 0x98}, 18);
            tfa_mem_done(tfa_dev);

            i2c_write(tfa_dev, MEM_DSP_PARAM[2], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x00, 0xc5, 0x28, 0xf5, 0x5f, 0x87, 
                                    0xae, 0x52, 0xdb, 0x29, 0xa0, 0x78, 0x52, 0x67, 0xfb, 0xe2}, 18);
            tfa_mem_done(tfa_dev);

            i2c_write(tfa_dev, MEM_DSP_PARAM[3], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x01, 0xcc, 0x30, 0x9d, 0x69, 0xcc, 
                                    0x3c, 0x34, 0x04, 0x5c, 0x96, 0x33, 0xc4, 0x3f, 0xcb, 0x07}, 18);
            tfa_mem_done(tfa_dev);

            i2c_write(tfa_dev, MEM_DSP_PARAM[4], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x01, 0xc4, 0xbc, 0x99, 0x7b, 0x07, 
                                    0xb4, 0x39, 0xe0, 0xc8, 0x84, 0xf8, 0x4c, 0x41, 0x62, 0x9e}, 18);
            tfa_mem_done(tfa_dev);

            i2c_write(tfa_dev, MEM_DSP_PARAM[5], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x00, 0xdc, 0xfd, 0x04, 0xcb, 0x9a, 
                                    0x04, 0x35, 0xda, 0x3e, 0x6b, 0xb4, 0x7c, 0x35, 0xda, 0x3e}, 18);
            tfa_mem_done(tfa_dev);

            i2c_write(tfa_dev, MEM_DSP_PARAM[6], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x01, 0xed, 0xb3, 0x70, 0x32, 0xf3, 
                                    0x6b, 0x15, 0x02, 0x85, 0xc4, 0xeb, 0x6f, 0x45, 0x6b, 0x31}, 18);
            tfa_mem_done(tfa_dev);

            i2c_write(tfa_dev, MEM_DSP_PARAM[7], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x01, 0xc6, 0x9c, 0x34, 0x78, 0xce, 
                                    0x29, 0x37, 0x45, 0xcb, 0x87, 0x31, 0xd7, 0x42, 0x1e, 0x01}, 18);
            tfa_mem_done(tfa_dev);

            i2c_write(tfa_dev, MEM_DSP_PARAM[8], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x01, 0xc6, 0x68, 0x1d, 0x77, 0xd6, 
                                    0x47, 0x3a, 0x39, 0x01, 0x88, 0x29, 0xb9, 0x3f, 0x5e, 0xe1}, 18);
            tfa_mem_done(tfa_dev);

            i2c_write(tfa_dev, MEM_DSP_PARAM[9], 7);
            i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x01, 0xcb, 0x7d, 0x57, 0x73, 0x5f, 
                                    0x2e, 0x31, 0x6e, 0x39, 0x93, 0x1d, 0x25, 0x3c, 0x98, 0x1c}, 18);
            tfa_mem_done(tfa_dev);

            break;
        case 3:
            break;
    }

    return 0;
}

int tfa_coldboot(tfa_device_t *tfa_dev)
{
    ALOGI(" [COLDBOOT] Start");
    //reset
    i2c_write(tfa_dev, (unsigned char []){0x09, 0x00, 0x02}, 2);
    //battery protect
    i2c_write(tfa_dev, (unsigned char []){0x05, 0x13, 0xab}, 2);
    //volume set 0, no mute
    i2c_write(tfa_dev, (unsigned char []){0x06, 0x00, 0x1f}, 2);
    //speaker calibration param
    i2c_write(tfa_dev, (unsigned char []){0x08, 0x3c, 0x4e}, 2);
    //mark amp params set
    i2c_write(tfa_dev, (unsigned char []){0x09, 0x02, 0x4d}, 2);
    //ppm mute set
    i2c_write(tfa_dev, (unsigned char []){0x41, 0x03, 0x08}, 2);
    //CurrentSense4
    i2c_write(tfa_dev, (unsigned char []){0x49, 0x0e, 0x82}, 2);
    //dcdcboost set
    i2c_write(tfa_dev, (unsigned char []){0x07, 0x0f, 0xe7}, 2);
    //i2s enable
    i2c_write(tfa_dev, (unsigned char []){0x04, 0x88, 0x9b}, 2);
    //i2s reg set
    i2c_write(tfa_dev, (unsigned char []){0x0a, 0x3e, 0xc2}, 2);
    //control - powerup
    i2c_write(tfa_dev, (unsigned char []){0x09, 0x02, 0x4c}, 2);

    int retries = 0;
    while (!tfa_dev->status.flag_clocks_stable && retries<=20) {
        if (retries==0) 
            ALOGI(" [COLDBOOT] Waiting for DSP system stable...");
        usleep(100000);
        ++retries;
        tfa_status_read(tfa_dev);
    } 

    if (retries>20) {
        ALOGE(" [COLDBOOT] Timeout waiting for DSP clocks!");
        ALOGE(" [COLDBOOT] DEBUG: Tries count: %d", retries);
        tfa_status_log(tfa_dev);
        return 1;
    }
    ALOGI(" [COLDBOOT] DSP system stable [OK]: %d retries", retries);

    //mem prepare
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02}, 2);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x00, 0xa1}, 2);
    i2c_read(tfa_dev, 0x72, NULL, 3);

    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02}, 2);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x21, 0xb4}, 2);
    i2c_read(tfa_dev, 0x72, NULL, 3);
   
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x01}, 2);
    i2c_write(tfa_dev, (unsigned char []){0x71, 
    0x40, 0x00, 0x6a, 0x7f, 0xfd, 0x28, 0x3a, 0x91, 0x01, 0xe7, 0x3a, 0x8a, 0xfe, 0x1b, 0x3a, 0x99, 0x01, 0xe4, 0x62, 0x88, 0x55, 0x7e, 0x6a, 
    0xfe, 0xc3, 0x08, 0xb5, 0x00, 0x58, 0x7c, 0x30, 0x50, 0x00, 0x80, 0x3b, 0x80, 0x05, 0xf0, 0x3c, 0xc9, 0xff, 0xd9, 0x8b, 0x00, 0x54, 0x3d, 0x3a, 
    0x80, 0xfe, 0xe0, 0x38, 0x68, 0x20, 0x00, 0xb5, 0x00, 0x42, 0x80, 0x82, 0x14, 0x5e, 0x7a, 0x3a, 0x90, 0xff, 0x79, 0x3b, 0x43, 0x40, 0x9a, 0x6d, 
    0x3e, 0xdc, 0x7b, 0x62, 0x05, 0x54, 0xbe, 0x3a, 0x99, 0xfe, 0xa1, 0x6a, 0xfc, 0xd5, 0x7e, 0x30, 0x60, 0x00, 0x80, 0x30, 0xa0, 0x01, 0x80, 0x3b, 
    0x80, 0x04, 0x14, 0x80, 0xb8, 0x44, 0x88, 0x30, 0x50, 0x01, 0x00, 0x38, 0x0c, 0x20, 0x14, 0x30, 0x70, 0x00, 0x80, 0x3b, 0x80, 0x00, 0x47, 0x30, 
    0x80, 0x01, 0x00, 0x30, 0x80, 0x01, 0x80, 0x38, 0x0a, 0x20, 0x01, 0x20, 0x80, 0x40, 0x25, 0x30, 0x90, 0x01, 0x00, 0xb5, 0x00, 0x42, 0x09, 0xb5, 
    0x00, 0x43, 0x00, 0xd4, 0xc8, 0x42, 0x09, 0x60, 0x20, 0xfe, 0x9c, 0x30, 0x90, 0x01, 0x00, 0x30, 0x50, 0x00, 0x80, 0x30, 0xa0, 0x20, 0x55, 0x3b, 
    0x80, 0x05, 0xa8, 0x30, 0x80, 0x01, 0x80, 0x30, 0x50, 0x00, 0x80, 0x30, 0x80, 0x01, 0x00, 0x3b, 0x80, 0x03, 0xb0, 0x30, 0x90, 0x01, 0x00, 0x61, 
    0x40, 0x54, 0x39, 0x82, 0x14, 0x7e, 0x9c, 0x3b, 0x65, 0x40, 0x36, 0x34, 0x00, 0x07, 0x7e, 0x34, 0x00, 0x02, 0xff, 0x3b, 0x00, 0x40, 0x9b, 0x34, 
    0x00, 0x07, 0x7f, 0x30, 0x80, 0x01, 0x00, 0x30, 0xa0, 0x01, 0x80, 0x30, 0x50, 0x00, 0x40, 0x3b, 0x80, 0x04, 0x88, 0x3a, 0x88, 0x00, 0x01, 0x30, 
    0x90, 0x01, 0x00, 0x30, 0x40, 0x00, 0x3f, 0x30, 0x80, 0x01, 0x80}, 250);
    
    i2c_write(tfa_dev, (unsigned char []){0x71, 
    0x40, 0x3e, 0xb5, 0x00, 0x7a, 0x00, 0x20, 0x3f, 0x40, 0x47, 0x38, 0x0a, 0x20, 0x00, 0x8b, 0xe0, 0x61, 0x85, 0xb5, 0x00, 0x41, 0x09, 0xa2, 
    0x19, 0x7e, 0x9c, 0x3b, 0x67, 0x40, 0x46, 0x80, 0xc8, 0x60, 0x07, 0x90, 0xfc, 0xfe, 0x9c, 0xb5, 0x00, 0x7e, 0x9c, 0x7b, 0x20, 0x64, 0x00, 0xb5, 
    0x00, 0x50, 0x79, 0x3b, 0x80, 0x03, 0x96, 0xb0, 0xd0, 0x62, 0x09, 0x3a, 0x20, 0xff, 0xf9, 0xb5, 0x00, 0x7a, 0x60, 0x30, 0x90, 0x01, 0x00, 0x20, 
    0x3f, 0x40, 0x53, 0x30, 0x80, 0x01, 0x80, 0x8b, 0x40, 0x40, 0x01, 0xb2, 0x0c, 0x7e, 0x9c, 0xa0, 0x48, 0x40, 0x01, 0x7b, 0x04, 0x50, 0x3b, 0x3c, 
    0xd8, 0x06, 0x04, 0xb5, 0x00, 0x5a, 0x3d, 0x20, 0x17, 0x40, 0x5a, 0x9b, 0xa4, 0xc3, 0x00, 0xa6, 0xba, 0xde, 0x3a, 0xb4, 0x02, 0xfe, 0x9c, 0x9b, 
    0x87, 0xe1, 0x74, 0xb5, 0x00, 0x61, 0x82, 0xd0, 0x34, 0x74, 0x18, 0x30, 0xa0, 0x07, 0xfe, 0x38, 0x0a, 0x0f, 0x95, 0x38, 0x0c, 0x0f, 0x94, 0xa4, 
    0x02, 0x62, 0x4a, 0x3b, 0x80, 0x03, 0x35, 0x9b, 0xe0, 0xd0, 0x58, 0x38, 0x0a, 0x0f, 0x97, 0x38, 0x0c, 0x0f, 0x96, 0x30, 0xa0, 0x07, 0xff, 0xb5, 
    0x00, 0x74, 0x18, 0x3b, 0x80, 0x03, 0x35, 0x9b, 0xe0, 0xe2, 0x4a, 0x38, 0x0a, 0x07, 0xfe, 0x38, 0x0c, 0x0f, 0x98, 0xa2, 0x17, 0x7e, 0x9c, 0x3b, 
    0x64, 0x40, 0x70, 0x3b, 0x00, 0x40, 0x71, 0x34, 0x00, 0x07, 0x7e, 0x34, 0x01, 0x07, 0x7e, 0x38, 0x0a, 0x07, 0xff, 0x38, 0x0c, 0x0f, 0x99, 0xa2, 
    0x17, 0x7e, 0x9c, 0x3b, 0x64, 0x40, 0x77, 0x3b, 0x00, 0x40, 0x78, 0x34, 0x00, 0x07, 0x7f, 0x34, 0x01, 0x07, 0x7f, 0x30, 0x80, 0x01, 0x00, 0x3a, 
    0x80, 0x00, 0x19, 0x3b, 0x80, 0x03, 0x8f, 0x8b, 0xa0, 0x7a, 0xcc}, 250);

    i2c_write(tfa_dev, (unsigned char []){0x71, 
    0x40, 0x7c, 0x94, 0x11, 0x7e, 0x9c, 0x38, 0x0c, 0x0f, 0x9e, 0xb5, 0x00, 0x61, 0x40, 0x30, 0x80, 0x07, 0x7c, 0x3b, 0x80, 0x04, 0x65, 0xb5, 
    0x00, 0x52, 0xf9, 0x38, 0x04, 0x07, 0x7c, 0x9b, 0xa5, 0xd0, 0x39, 0xb0, 0x61, 0x50, 0x3b, 0xa6, 0xaa, 0xfe, 0x9c, 0x3c, 0xd8, 0x06, 0x04, 0x20, 
    0x17, 0x40, 0x8a, 0x80, 0xd4, 0x5a, 0x3d, 0xba, 0xa1, 0xde, 0x3a, 0xb4, 0x03, 0x7e, 0x9c, 0x9b, 0x86, 0x61, 0xb4, 0xd0, 0x34, 0x7e, 0x9c, 0x38, 
    0x0c, 0x0f, 0x9e, 0xa4, 0x02, 0x7e, 0x9c, 0x30, 0x80, 0x07, 0x7d, 0x3b, 0x80, 0x04, 0x65, 0xb5, 0x00, 0x61, 0x40, 0x38, 0x0a, 0x07, 0x7d, 0x38, 
    0x0c, 0x0f, 0x9c, 0xa2, 0x17, 0x7e, 0x9c, 0x3b, 0x64, 0x40, 0x98, 0x3b, 0x00, 0x40, 0x9b, 0x34, 0x00, 0x02, 0xff, 0x3b, 0x00, 0x40, 0x9b, 0x34, 
    0x01, 0x02, 0xff, 0xb5, 0x00, 0x55, 0x7e, 0x61, 0x00, 0xd4, 0x3e, 0x3a, 0x88, 0xff, 0xec, 0x38, 0x0c, 0x0f, 0x9a, 0xb5, 0x00, 0x42, 0x88, 0xd0, 
    0x35, 0x40, 0x00, 0x38, 0x0a, 0x02, 0xff, 0x82, 0x14, 0x6d, 0x04, 0x3a, 0x81, 0x01, 0x22, 0x3b, 0x43, 0x40, 0xae, 0x70, 0xc1, 0x54, 0x7e, 0x9b, 
    0x43, 0xe1, 0x40, 0x38, 0x00, 0x0f, 0x9b, 0xc6, 0x8a, 0x7e, 0x9c, 0x38, 0x0c, 0x0f, 0x9d, 0xa4, 0x01, 0x7e, 0x9c, 0x30, 0x80, 0x07, 0x7b, 0x3b, 
    0x80, 0x04, 0x65, 0xb5, 0x00, 0x61, 0x40, 0x3b, 0x20, 0x40, 0xbc, 0xb5, 0x00, 0x54, 0x3f, 0x3a, 0x80, 0x00, 0x3d, 0xb5, 0x00, 0x42, 0x80, 0xa2, 
    0x02, 0xfe, 0x9c, 0x3b, 0x64, 0x40, 0xb8, 0xd0, 0x4c, 0x7e, 0x9c, 0xb5, 0x00, 0x7e, 0x9c, 0x94, 0x03, 0xfe, 0x9c, 0x3b, 0x00, 0x40, 0xb9, 0xb5, 
    0x00, 0x61, 0x40, 0x38, 0x0a, 0x20, 0x14, 0x30, 0x80, 0x07, 0x7b}, 250);

    i2c_write(tfa_dev, (unsigned char []){0x71,
    0x40, 0xba, 0x3b, 0x80, 0x04, 0x65, 0x38, 0x0c, 0x0f, 0x9f, 0x38, 0x0a, 0x07, 0x7b, 0x68, 0x1d, 0xd4, 0x3e, 0x3c, 0xd8, 0x06, 0x04, 0x20, 0x17, 
    0x40, 0xc2, 0x9b, 0xc5, 0xda, 0x3d, 0xa6, 0xb7, 0x5e, 0x3a, 0xb4, 0x02, 0xfe, 0x9c, 0xb5, 0x00, 0x42, 0x80, 0x92, 0x15, 0x54, 0xbf, 0x3a, 0x80, 
    0x00, 0x0c, 0x3b, 0x43, 0x40, 0xd9, 0xb5, 0x00, 0x5a, 0x7f, 0x3a, 0x89, 0x00, 0xca, 0x8b, 0xa0, 0x45, 0x08, 0x3a, 0x92, 0x00, 0x2f, 0x61, 0x88, 
    0x54, 0xfe, 0x3a, 0x89, 0x00, 0x88, 0xb5, 0x00, 0x54, 0x7d, 0x3b, 0x80, 0x04, 0xbb, 0xb8, 0x83, 0x54, 0xfb, 0x39, 0x04, 0x20, 0x1f, 0xb3, 0x01, 
    0x52, 0xbf, 0x9b, 0xc8, 0x7a, 0x8a, 0xa4, 0x03, 0x55, 0x3b, 0xb5, 0x00, 0x61, 0x80, 0xd0, 0x4c, 0x54, 0x3d, 0xb5, 0x00, 0x54, 0xbe, 0xa4, 0x02, 
    0x7e, 0x9c, 0xb5, 0x00, 0x40, 0x50, 0xb5, 0x00, 0x42, 0x80, 0x92, 0x15, 0x7e, 0x9c, 0x3b, 0x63, 0x40, 0xec, 0x8b, 0xa0, 0x44, 0x08, 0x3a, 0x80, 
    0x00, 0x2f, 0x3a, 0x89, 0x00, 0x94, 0xb5, 0x00, 0x43, 0x00, 0x3b, 0x80, 0x04, 0xbb, 0xb8, 0x83, 0x54, 0xfe, 0x39, 0x04, 0x20, 0x1f, 0xb3, 0x01, 
    0x52, 0xbf, 0x9b, 0xc8, 0x7a, 0x8a, 0xa4, 0x03, 0x54, 0x3e, 0xb5, 0x00, 0x61, 0x80, 0xd0, 0x4c, 0x58, 0x3c, 0xb5, 0x00, 0x7e, 0x9c, 0xa4, 0x02, 
    0x7e, 0x9c, 0x3b, 0x00, 0x40, 0xed, 0xb5, 0x00, 0x40, 0x40, 0xb5, 0x00, 0x58, 0x3c, 0x3c, 0xd8, 0x03, 0x00, 0x8b, 0x80, 0x7d, 0x58, 0xb5, 0x00, 
    0x7e, 0x9c, 0x61, 0x00, 0x7d, 0x04, 0x3a, 0x88, 0x01, 0xe2, 0x6a, 0x3e, 0xd2, 0x7e, 0xb5, 0x00, 0x58, 0x7c, 0x3b, 0x80, 0x07, 0x45, 0xb5, 0x00, 
    0x54, 0xff, 0x6a, 0x5e, 0xd4, 0x3e, 0x3a, 0x80, 0x00, 0x05}, 250);

    i2c_write(tfa_dev, (unsigned char []){0x71,
    0x40, 0xf8, 0x3a, 0x98, 0x00, 0x33, 0x3a, 0x91, 0x01, 0xe8, 0x38, 0x00, 0x07, 0x7e, 0x82, 0x00, 0x41, 0x1a, 0x61, 0x8c, 0x40, 0x91, 0xb5, 0x00, 
    0x40, 0x10, 0x3b, 0x43, 0x41, 0x15, 0x76, 0x80, 0xd5, 0x3f, 0xa2, 0x11, 0x7e, 0x9c, 0x3b, 0x64, 0x41, 0x15, 0xa2, 0x13, 0x7e, 0x9c, 0x3b, 0x67, 
    0x41, 0x15, 0xb5, 0x00, 0x44, 0x08, 0x3a, 0x80, 0x00, 0x29, 0x61, 0x2a, 0x42, 0x00, 0xb5, 0x00, 0x42, 0x10, 0xd1, 0x84, 0x58, 0x3c, 0x3a, 0x82, 
    0x00, 0x08, 0x94, 0x00, 0xfe, 0x9c, 0x65, 0x20, 0xfe, 0x80, 0xb5, 0x00, 0x48, 0x40, 0x3a, 0x88, 0xfe, 0x67, 0x3a, 0x81, 0x01, 0x98, 0x61, 0x04, 
    0x60, 0x38, 0xb5, 0x00, 0x4a, 0x00, 0xb3, 0x02, 0x7e, 0x9c, 0xb5, 0x00, 0x4a, 0x41, 0x3b, 0x00, 0x41, 0x2a, 0xb5, 0x00, 0x48, 0x40, 0x38, 0x02, 
    0x07, 0x7f, 0x82, 0x04, 0x7e, 0x50, 0x3b, 0x63, 0x41, 0x1c, 0xa2, 0x11, 0x7e, 0x9c, 0x3b, 0x64, 0x41, 0x1c, 0xa2, 0x13, 0x7e, 0x9c, 0x3b, 0x66, 
    0x41, 0x29, 0x3a, 0x89, 0x01, 0xe1, 0xb5, 0x00, 0x42, 0x08, 0x3a, 0x89, 0x00, 0x07, 0xd1, 0x84, 0x62, 0x89, 0x3a, 0x80, 0x00, 0x3c, 0x94, 0x00, 
    0xc2, 0x00, 0x65, 0x24, 0xfe, 0x80, 0x70, 0x1c, 0x48, 0x48, 0xb5, 0x00, 0x4a, 0x10, 0xb2, 0x02, 0x58, 0x3c, 0xb5, 0x00, 0x4a, 0x50, 0x3b, 0x00, 
    0x41, 0x2a, 0xb5, 0x00, 0x48, 0x48, 0xb5, 0x00, 0x58, 0x3c, 0x3c, 0xd8, 0x03, 0x00, 0x8b, 0x80, 0x7d, 0x7c, 0xb5, 0x00, 0x7e, 0x9c, 0x38, 0x00, 
    0x00, 0xb0, 0x30, 0x20, 0x7f, 0x00, 0xa8, 0x41, 0x7a, 0x68, 0xa7, 0x89, 0xfd, 0x01, 0x83, 0x10, 0x7e, 0x9c, 0x38, 0x09, 0x02, 0x71, 0x30, 0x10, 
    0x00, 0xff, 0x3b, 0x42, 0x41, 0x55, 0xa8, 0x00, 0xd8, 0x7f}, 250);
    
    i2c_write(tfa_dev, (unsigned char []){0x71,
    0x41, 0x36, 0x38, 0x01, 0x02, 0x72, 0x93, 0x10, 0xfe, 0x9c, 0x3b, 0x62, 0x41, 0x50, 0x93, 0x11, 0x7e, 0x9c, 0x3b, 0x62, 0x41, 0x4b, 0xb5, 0x00, 
    0x7a, 0x09, 0xa3, 0x10, 0x7e, 0x9c, 0x3b, 0x62, 0x41, 0x40, 0x3b, 0x00, 0x41, 0x49, 0x34, 0x02, 0x00, 0xca, 0x38, 0x00, 0x00, 0x02, 0x38, 0x01, 
    0x00, 0xde, 0x3b, 0x80, 0x0a, 0xa4, 0x96, 0xa2, 0x7a, 0x83, 0x3b, 0x80, 0x0a, 0xa4, 0x8b, 0x80, 0x7a, 0xa3, 0x3b, 0x80, 0x0a, 0xbf, 0xb5, 0x00, 
    0x7e, 0x9c, 0x34, 0x00, 0x00, 0xca, 0x3b, 0x00, 0x41, 0x59, 0xb5, 0x00, 0x58, 0x3f, 0x3b, 0x80, 0x0b, 0x1a, 0xb5, 0x00, 0x7e, 0x9c, 0xb5, 0x00, 
    0x58, 0x3f, 0x3b, 0x00, 0x41, 0x59, 0x38, 0x09, 0x00, 0xca, 0x3b, 0x80, 0x0a, 0xc4, 0xb5, 0x00, 0x7e, 0x9c, 0xb5, 0x00, 0x58, 0x3f, 0x3b, 0x00, 
    0x41, 0x59, 0x38, 0x09, 0x00, 0xca, 0x3b, 0x80, 0x0b, 0x4e, 0xb5, 0x00, 0x7e, 0x9c, 0x38, 0x09, 0x00, 0xca, 0xb5, 0x00, 0x58, 0x3f, 0x3c, 0xd8, 
    0x03, 0x00, 0x7f, 0x4e, 0x7d, 0x7f, 0x6a, 0xbf, 0xfd, 0x26, 0x3a, 0x9a, 0x00, 0x38, 0xb5, 0x00, 0x46, 0x13, 0x3a, 0xa4, 0x00, 0x05, 0xb5, 0x00, 
    0x56, 0x7e, 0x3a, 0xa4, 0x00, 0x04, 0xb5, 0x00, 0x40, 0x20, 0x82, 0x00, 0x58, 0x7b, 0xb5, 0x00, 0x54, 0xfc, 0x3b, 0x42, 0x41, 0x69, 0x61, 0x48, 
    0x55, 0xfd, 0x3b, 0x80, 0x03, 0xf8, 0x3c, 0xc9, 0xff, 0xda, 0x3b, 0x20, 0x41, 0x6f, 0x80, 0xf4, 0x54, 0x3f, 0x3a, 0x80, 0x00, 0x29, 0x3a, 0x88, 
    0x00, 0x10, 0x61, 0x44, 0x44, 0x00, 0x3b, 0x80, 0x03, 0x44, 0x9b, 0xc3, 0xf4, 0x5a, 0x7a, 0x0d, 0x54, 0xbc, 0x3b, 0x80, 0x1a, 0x91, 0xb5, 0x00, 
    0x55, 0x3f, 0xb5, 0x00, 0x54, 0x3f, 0x3a, 0x80, 0x00, 0x13}, 250);

    i2c_write(tfa_dev, (unsigned char []){0x71,
    0x41, 0x74, 0x3a, 0x88, 0xff, 0xef, 0x61, 0xc4, 0x42, 0x80, 0x6a, 0x7d, 0x54, 0x3c, 0x3b, 0x80, 0x03, 0x44, 0x9b, 0xc3, 0xf4, 0x5a, 0x38, 0x12, 
    0x00, 0xd6, 0x7c, 0x24, 0xd4, 0x3a, 0xb5, 0x00, 0x43, 0x00, 0x3b, 0x80, 0x04, 0x24, 0x9b, 0xa1, 0xf4, 0x1a, 0x9b, 0x00, 0xd4, 0xba, 0x3a, 0x81, 
    0x00, 0x94, 0x80, 0xa0, 0x45, 0x02, 0x66, 0x00, 0x43, 0x88, 0x3a, 0x98, 0xff, 0x99, 0x7a, 0x2d, 0x55, 0xfa, 0x3b, 0x80, 0x05, 0xd4, 0x80, 0xd4, 
    0x54, 0x3c, 0x7c, 0x66, 0xd4, 0xba, 0x3a, 0x83, 0x00, 0x3a, 0x31, 0x0f, 0xff, 0x9d, 0x60, 0x0c, 0x42, 0x85, 0x3a, 0x90, 0x00, 0x35, 0x90, 0x03, 
    0xc1, 0x08, 0xa2, 0x08, 0x43, 0x80, 0x3a, 0x9a, 0x00, 0x55, 0xb5, 0x00, 0x40, 0x90, 0x3b, 0x44, 0x41, 0x96, 0x60, 0x0c, 0x54, 0x3f, 0x82, 0x14, 
    0x7e, 0x9c, 0x3b, 0x62, 0x41, 0xb9, 0x30, 0x20, 0x02, 0x00, 0xa2, 0x15, 0x7e, 0x9c, 0x3b, 0x62, 0x41, 0xb9, 0x82, 0x04, 0x7e, 0x9c, 0x3b, 0x62, 
    0x41, 0x9f, 0x82, 0x00, 0x7e, 0x9c, 0x3b, 0x62, 0x41, 0x9f, 0x82, 0x14, 0x7e, 0x9c, 0x3b, 0x62, 0x41, 0xb5, 0x30, 0x00, 0x02, 0x00, 0xa2, 0x14, 
    0x7e, 0x9c, 0x3b, 0x62, 0x41, 0xb5, 0x3a, 0x88, 0x00, 0x61, 0x61, 0x86, 0xfb, 0x24, 0xb5, 0x00, 0x54, 0x3c, 0x3b, 0x80, 0x00, 0x47, 0xb5, 0x00, 
    0x54, 0xff, 0x6a, 0x5f, 0x54, 0x3f, 0x31, 0x0f, 0xff, 0x9d, 0x3a, 0x91, 0x00, 0x15, 0x61, 0x48, 0x42, 0x45, 0x6a, 0x5e, 0x43, 0x00, 0xb5, 0x00, 
    0x54, 0x7f, 0x3b, 0x80, 0x03, 0x96, 0xb5, 0x00, 0x54, 0x3c, 0x61, 0x40, 0x54, 0x3f, 0x3a, 0x88, 0x00, 0x36, 0x71, 0x05, 0x55, 0x3c, 0xb5, 0x00, 
    0x54, 0xff, 0x3b, 0x80, 0x03, 0xdc, 0x3c, 0xc9, 0xff, 0xda}, 250);

    i2c_write(tfa_dev, (unsigned char []){0x71,
    0x41, 0xb2, 0x6a, 0x1f, 0xd8, 0x3b, 0x3b, 0x00, 0x41, 0xda, 0xb5, 0x00, 0x7e, 0x40, 0x9b, 0x00, 0xd8, 0x3b, 0xb5, 0x00, 0x54, 0x3d, 0x3b, 0x00, 
    0x41, 0xda, 0xb5, 0x00, 0x40, 0x40, 0x3a, 0x80, 0x00, 0x63, 0x30, 0x20, 0x01, 0x00, 0x30, 0x50, 0x04, 0x00, 0xaa, 0x7e, 0xc1, 0x41, 0xba, 0x42, 
    0xfe, 0x41, 0xba, 0xa3, 0xfe, 0x40, 0x3a, 0x80, 0xff, 0xab, 0x80, 0xf4, 0x42, 0x00, 0x38, 0x0a, 0x02, 0x7f, 0x38, 0x0c, 0x02, 0x7e, 0xd2, 0x7d, 
    0xe1, 0x03, 0x3a, 0x80, 0x00, 0x48, 0xb9, 0xc1, 0x60, 0xc3, 0xa0, 0x6e, 0xfb, 0x04, 0x9b, 0xab, 0xc1, 0xc1, 0xb0, 0x77, 0x41, 0xc5, 0x3c, 0xd8, 
    0x06, 0x04, 0x3c, 0xc3, 0x41, 0xcd, 0xb5, 0x00, 0x54, 0xbd, 0xa6, 0x49, 0xd8, 0x3b, 0xb4, 0x4b, 0xfe, 0x9c, 0x82, 0x10, 0x61, 0x76, 0xbf, 0xb2, 
    0xfe, 0x9c, 0x82, 0x04, 0x7e, 0x9c, 0x95, 0x75, 0x7e, 0x9c, 0x3b, 0x42, 0x41, 0xd7, 0x90, 0x6d, 0x7e, 0x9c, 0x9b, 0x40, 0xc1, 0xc0, 0x82, 0x00, 
    0x7e, 0x9c, 0x3b, 0x63, 0x41, 0xd9, 0x3b, 0x00, 0x41, 0xda, 0xb5, 0x00, 0x7e, 0x48, 0xb5, 0x00, 0x41, 0x48, 0x3c, 0xd8, 0x03, 0x00, 0x8b, 0x80, 
    0x7d, 0x5a, 0xb5, 0x00, 0x7e, 0x9c, 0x3a, 0x80, 0x00, 0x10, 0xb5, 0x00, 0x42, 0x80, 0x38, 0x08, 0x02, 0x7f, 0x38, 0x0c, 0x02, 0x7e, 0xd2, 0xbc, 
    0x7e, 0x9c, 0x3a, 0x80, 0x00, 0x48, 0xb5, 0x00, 0x61, 0x40, 0xa0, 0x96, 0x7e, 0x9c, 0xb5, 0x00, 0x42, 0x41, 0x3c, 0xd8, 0x03, 0x00, 0x7f, 0x20, 
    0x42, 0x41}, 218);

    i2c_write(tfa_dev, (unsigned char []){0x71, 0x00, 0x07}, 2);

    i2c_write(tfa_dev, (unsigned char []){0x71, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x07, 0xf1, 0x00, 
    0x41, 0x2d, 0x00, 0x3b, 0x80, 0x00, 0x00, 0x01, 0x00, 0x0f, 0xa8, 0x00, 0x41, 0xdd, 0x00, 0x3b, 
    0x80, 0x00, 0x00, 0x01, 0x00, 0x12, 0x72, 0x00, 0x41, 0x5b, 0x00, 0x3b, 0x80, 0x00, 0x00, 0x01, 
    0x00, 0x16, 0x27, 0x00, 0x40, 0x00, 0x00, 0x3b, 0x80, 0x00, 0x00, 0x01, 0x00, 0x16, 0x29, 0x00, 
    0x40, 0xf0, 0x00, 0x3b, 0x80, 0x00, 0x00, 0x00}, 65);
    
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x03, 0x18, 0x00, 0x00, 0x00}, 5);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x03, 0x1c, 0x00, 0x00, 0x00}, 5);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x03, 0x20, 0x00, 0x00, 0x00}, 5);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x03, 0x24, 0x00, 0x00, 0x01, 0x00, 0x13, 0x9c, 0x00, 0x7e, 0x40, 0x00, 0xb5, 0x00}, 14); 
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x03}, 2);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x02, 0x7e, 0x40, 0x00, 0x00, 0x06, 0x40, 0x00}, 8);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x02, 0xff, 0x00, 0x00, 0x00}, 5);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x07, 0x7b, 0x7f, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}, 17);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x07, 0xfe, 0x7f, 0xff, 0xff, 0x7f, 0xff, 0xff}, 8);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x0f, 0x94, 0x70, 0x05, 0xad, 0x7f, 0xd4, 0x56, 0x7f, 0xf7, 
                                          0x43, 0x70, 0x05, 0xad, 0x06, 0x66, 0x66, 0x19, 0x99, 0x99, 0x40, 0x00, 0x00, 0x00, 0x00, 0x03, 0x11, 
                                          0xeb, 0x85, 0x7f, 0xea, 0x29, 0x7c, 0x65, 0x05, 0x7f, 0xfb, 0xa1}, 38);

    i2c_write(tfa_dev, (unsigned char []){0x71, 0x12, 0xbf, 0x05, 0x01, 0x01}, 5);
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x00}, 2);

    i2c_read(tfa_dev, 0x80, NULL, 2);
    i2c_read(tfa_dev, 0x80, NULL, 2);

    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02, 0x00, 0x01, 0x00, 0x81, 0x0e}, 7);
    i2c_write(tfa_dev, (unsigned char []){0x72, 0x09, 0xf3, 0x33, 0x01, 0x3e, 0x66, 0x00, 0x54, 
    0xcd, 0x00, 0x00, 0x64, 0x00, 0x00, 0x02, 0x1a, 0xf5, 0xdf, 0x1b, 0x50, 0xa8, 0x1c, 0x6a, 
    0x51, 0x00, 0x30, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 
    0x00, 0x00, 0x01, 0x4b, 0x00, 0x01, 0x4b, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfa, 0x00, 0x00, 
    0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x01, 0x00, 
    0x00, 0x10, 0x00, 0x00, 0x01, 0xeb, 0x85, 0x00, 0x01, 0x06, 0x00, 0x19, 0x9a, 0x00, 0x00, 
    0x00, 0x00, 0x0c, 0xcd, 0x02, 0x80, 0x00, 0x00, 0x00, 0x01, 0x05, 0x00, 0x00, 0x05, 0x00, 
    0x00, 0x00, 0x0f, 0xff, 0x07, 0xc2, 0x8f, 0x00, 0x10, 0x00, 0x08, 0x00, 0x00, 0x00, 0x19, 
    0x9a, 0x00, 0x00, 0x80, 0x00, 0x00, 0x02, 0x00, 0x00, 0x01, 0x01, 0x47, 0xae, 0x00, 0x00, 
    0x40, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 
    0x30, 0x00, 0x00, 0x02, 0x00, 0x00, 0x18, 0xec, 0x00, 0x00, 0x00, 0x03, 0xd7, 0x01, 0x00, 
    0x00, 0x20, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x05, 0xe9, 0x80, 
    0x00, 0xb0, 0x00, 0x00, 0x00, 0x0c, 0xcd, 0x01, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 
    0x08, 0x00, 0x80, 0x00, 0x14, 0x00, 0x00, 0x02, 0xcc, 0xcd, 0x04, 0x00, 0x00}, 201);

    tfa_mem_done(tfa_dev);

    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02, 0x00, 0x01, 0x00, 0x80, 0x85}, 7);

    tfa_mem_done(tfa_dev);

    i2c_write(tfa_dev, (unsigned char []){0x71, 0x00, 0x02}, 2);
    i2c_read(tfa_dev, 0x72, NULL, 6);
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02, 0x00, 0x01, 0x00, 0x81, 0x10}, 7);
    i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x00}, 3);

    tfa_mem_done(tfa_dev);

    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02, 0x00, 0x01, 0x00, 0x81, 0x06}, 7);

    i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x04, 0xba, 0x00, 0x00, 0x1a, 0x00, 0x02, 
    0xf0, 0x00, 0x03, 0x16, 0x00, 0x04, 0xf4, 0x00, 0x02, 0x87, 0x00, 0x03, 0x7a, 0x00, 0x01, 
    0x2e, 0x00, 0x04, 0xc3, 0x00, 0x01, 0xa5, 0x00, 0x03, 0xaa, 0x00, 0x02, 0x5a, 0x00, 0x05, 
    0x97, 0xff, 0xfe, 0xd3, 0x00, 0x06, 0xee, 0x00, 0x00, 0x85, 0x00, 0x05, 0xe4, 0xff, 0xfe, 
    0xe8, 0x00, 0x03, 0xc2, 0x00, 0x00, 0x1b, 0x00, 0x04, 0x32, 0x00, 0x01, 0xb0, 0x00, 0x03, 
    0x4f, 0xff, 0xfe, 0xcf, 0x00, 0x03, 0xe7, 0xff, 0xfe, 0x3c, 0x00, 0x04, 0xb5, 0xff, 0xfe, 
    0x9a, 0x00, 0x02, 0x65, 0xff, 0xfc, 0x8e, 0x00, 0x03, 0x0c, 0xff, 0xfe, 0x43, 0x00, 0x04, 
    0x7e, 0xff, 0xfd, 0x70, 0x00, 0x02, 0x08, 0xff, 0xfd, 0x87, 0x00, 0x03, 0xa1, 0xff, 0xfd, 
    0x9c, 0x00, 0x02, 0x7c, 0xff, 0xff, 0x83, 0x00, 0x02, 0x00, 0xff, 0xff, 0xa4, 0x00, 0x01, 
    0xe6, 0x00, 0x00, 0xd8, 0x00, 0x01, 0x45, 0x00, 0x01, 0x43, 0x00, 0x01, 0x52, 0x00, 0x02, 
    0x32, 0x00, 0x01, 0xbf, 0x00, 0x02, 0x13, 0xff, 0xff, 0xff, 0x00, 0x02, 0xe6, 0x00, 0x03, 
    0x44, 0x00, 0x02, 0x37, 0x00, 0x02, 0x9b, 0x00, 0x01, 0x07, 0x00, 0x01, 0x2e, 0x00, 0x01, 
    0x24, 0x00, 0x02, 0xed, 0x00, 0x00, 0x29, 0x00, 0x00, 0x1e, 0xff, 0xfe, 0xf6, 0x00, 0x01, 
    0x11, 0xff, 0xfc, 0xed, 0x00, 0x01, 0x41, 0xff, 0xf8, 0xe4, 0xff, 0xff, 0x4a, 0xff, 0xf9, 
    0x18, 0xff, 0xfe, 0x1f, 0xff, 0xf8, 0x31, 0xff, 0xfd, 0x89, 0xff, 0xf8, 0x24, 0xff, 0xf9, 
    0x95, 0xff, 0xf9, 0xd9, 0xff, 0xf8, 0x58, 0xff, 0xf7, 0xa6, 0xff, 0xf8, 0x7d, 0xff, 0xf5, 
    0xf8, 0xff, 0xf7, 0xd6, 0xff, 0xf9, 0x5f, 0xff, 0xf6, 0xd7, 0xff, 0xfa, 0x16, 0xff, 0xf6, 
    0xe5, 0xff, 0xf9, 0xde}, 252);

    i2c_write(tfa_dev, (unsigned char []){0x72, 0xff, 0xfa, 0x88, 0xff, 0xf9, 0xaf, 0xff, 0xfa, 
    0xc3, 0xff, 0xf9, 0x5d, 0xff, 0xfa, 0xf0, 0xff, 0xff, 0x02, 0xff, 0xff, 0x02, 0x00, 0x01, 
    0x75, 0xff, 0xfc, 0x80, 0x00, 0x02, 0x32, 0xff, 0xfc, 0xa1, 0x00, 0x08, 0xdc, 0xff, 0xfd, 
    0xc4, 0x00, 0x0f, 0x1e, 0xff, 0xfe, 0x3d, 0x00, 0x11, 0x3f, 0xff, 0xf6, 0x3b, 0x00, 0x11, 
    0xb0, 0xff, 0xef, 0xf7, 0x00, 0x22, 0x37, 0xff, 0xf7, 0x5d, 0x00, 0x38, 0x4d, 0xff, 0xe1, 
    0x7e, 0x00, 0x18, 0xe5, 0xff, 0xae, 0x98, 0x00, 0x1d, 0x17, 0xff, 0xe3, 0x77, 0x00, 0x9c, 
    0x6c, 0x00, 0x21, 0x5b, 0x00, 0x78, 0xd3, 0xff, 0x06, 0xfb, 0x08, 0x21, 0x55, 0x00, 0x83, 
    0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x71, 0xeb, 0x85, 0x68, 0xf5, 0xc3, 0x20, 0x00, 
    0x00, 0x20, 0x00, 0x00, 0x20, 0x00, 0x00, 0x29, 0x99, 0x9a, 0x00, 0x04, 0x5c, 0x00, 0x03, 
    0xe0, 0x02, 0x99, 0x9a, 0x00, 0x33, 0x33, 0x11, 0x80, 0x00, 0x00, 0x83, 0x12}, 171);

    tfa_mem_done(tfa_dev);

    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02, 0x00, 0x01, 0x00, 0x81, 0x10}, 7);
    i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x00}, 3);

    tfa_mem_done(tfa_dev);

    //set preset 1 (default)
    tfa_preset_write(tfa_dev, 1);

    //set volume api 4
    i2c_write(tfa_dev, (unsigned char []){0x06, 0x04, 0x1f}, 2);

    //drc hdr data
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02, 0x00, 0x01, 0x00, 0x81, 0x0f}, 7);

    i2c_write(tfa_dev, (unsigned char []){0x72, 0x00, 0x00, 0x01, 0x00, 0x27, 0xd8, 0x01, 0x6a, 0x0a, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x27, 0xd8, 0x01, 0x6a, 0x0a, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x03, 0x00, 0x02, 0x8a, 0x01, 0x6a, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x02, 
    0x8a, 0x01, 0x6a, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x27, 0xd8, 0x01, 0x6a, 0x0a, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x27, 0xd8, 0x01, 0x6a, 0x0a, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x04, 0x00, 0x02, 0x8a, 0x01, 0x6a, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x02, 
    0x8a, 0x01, 0x6a, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xff, 0xfd, 0xa8, 0x01, 0x6a, 0x0a, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xff, 0xfd, 0xa8, 0x01, 0x69, 0xfc, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 
    0x0a, 0x00, 0x00, 0x64, 0x02, 0x7a, 0x6d, 0x59, 0x99, 0x9a, 0xfe, 0x80, 0x00, 0x00, 0x00, 0x01, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x01, 0x00, 0x00, 0x03, 0x00, 0x00, 0x28, 0xf4, 
    0x7a, 0x6e, 0x42, 0x8f, 0x5c, 0x00, 0xa6, 0x66, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x14, 0x00, 0x00, 0x3c, 0xfc, 0xfa, 0x6e, 0x59, 0x99, 0x9a, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 
    0x00, 0x14, 0x00, 0x00, 0x1e, 0xfe, 0xfa, 0x6e, 0x26, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x14, 0x00, 0x00, 0x37, 
    0xfc, 0x7a, 0x6e}, 252);

    i2c_write(tfa_dev, (unsigned char []){0x72, 0x5e, 0xb8, 0x52, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00, 0x23, 0xfe, 
    0x7a, 0x6e, 0x40, 0x00, 0x00, 0xfe, 0x99, 0x9a, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x16, 0x00, 0x00, 0x4b, 0xfb, 0xfa, 0x6e, 0x60, 0x00, 0x00, 
    0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x01, 0x00, 0x00, 0x0a, 0x0b, 0x3a, 0x6d, 0x7f, 0xff, 0xff, 0x00, 0x40, 0x00, 0x00, 0x00, 
    0x01, 0x00, 0x03, 0x84, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x01, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x12, 0x00, 0x00, 0x4b, 0xfd, 
    0xfa, 0x6e, 0x59, 0x99, 0x9a, 0x00, 0x19, 0x9a}, 129);

    tfa_mem_done(tfa_dev);

//-----------------------------write drcHdr done------------------------

    i2c_write(tfa_dev, (unsigned char []){0x09, 0x02, 0x6c}, 2);

    i2c_read(tfa_dev, 0x70, NULL, 2);
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02}, 2);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x00, 0xe7}, 2);
    i2c_read(tfa_dev, 0x72, NULL, 3);
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02, 0x00, 0x01, 0x00, 0x81, 0x85}, 7);
    tfa_mem_done(tfa_dev);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x00, 0x02}, 2);
    i2c_read(tfa_dev, 0x72, NULL, 3);
    i2c_read(tfa_dev, 0x70, NULL, 2);
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02}, 2);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x00, 0xe7}, 2);
    i2c_read(tfa_dev, 0x72, NULL, 3);
    i2c_write(tfa_dev, (unsigned char []){0x70, 0x00, 0x02, 0x00, 0x01, 0x00, 0x81, 0x85}, 7);
    tfa_mem_done(tfa_dev);
    i2c_write(tfa_dev, (unsigned char []){0x71, 0x00, 0x02}, 2);
    i2c_read(tfa_dev, 0x72, NULL, 3);

    i2c_write(tfa_dev, (unsigned char []){0x06, 0x00, 0x1f}, 2);

    ALOGI(" [COLDBOOT] End");
    return 0;
}

int tfa_power(tfa_device_t *tfa_dev, bool on) {

    ALOGV("%s: %s amplifier device", __func__, on ? "Enabling" : "Disabling");

    pthread_mutex_lock(&tfa_dev->tfa_lock);
    
    if (tfa_dev->enabled == true && on == true) {
        ALOGV("%s: amplifier device already enabled!", __func__);
        goto pwr_end;
    }

    if (tfa_dev->enabled == false && on == false) {
        ALOGV("%s: amplifier device already disabled!", __func__);
        goto pwr_end;
    }
    
    tfa_clock_on(tfa_dev);

    if (on) {
        //enable amp code

        //status read: 001d
        tfa_status_read(tfa_dev);
        ALOGI(" [STATUS] Current TFA status is: 0x%02X%02X", tfa_dev->status.flag[0], tfa_dev->status.flag[1]);

        //i2s enable: 889b
        i2c_write(tfa_dev, (unsigned char []){0x04, 0x88, 0x9b}, 2);        
        ALOGI(" [I2S] Enabled I2S");

        //control read: 0265
        tfa_control_read(tfa_dev);
        ALOGI(" [CONTROL] Current TFA control reg is: 0x%02X%02X", tfa_dev->control.flag[0], tfa_dev->control.flag[1]);

        //mute
        i2c_write(tfa_dev, (unsigned char []){0x06, 0x00, 0x3f}, 2);

        //control: enable amp 0265->026d
        tfa_dev->control.flag_enable_amp = true;
        tfa_control_set(tfa_dev);
        ALOGI(" [CONTROL] Enabled Amplifier");

        //control: enable amp 026d->026c
        tfa_dev->control.flag_powerdown = false;
        tfa_control_set(tfa_dev);
        ALOGI(" [CONTROL] Enabled TFA");

        //unmute
        i2c_write(tfa_dev, (unsigned char []){0x06, 0x00, 0x1f}, 2);

        //control: enable bst 026c->027c
        tfa_dev->control.flag_enable_boost = true;
        tfa_control_set(tfa_dev);
        ALOGI(" [CONTROL] Enabled boost");

        //status: wait for d05f
        int retries = 0;
        ALOGI(" [POWERON] Waiting for start amplifier...");
        do {
            tfa_status_read(tfa_dev);
            usleep(10000); //0.01s
            ++retries;
        } while ((tfa_dev->status.flag[0]!=0xd0) && retries<=200);

        if (retries>200) {
            ALOGE(" [POWERON] Timeout waiting for start amplifier! Maybe it's unconfigured. Please, send full logcat to developer!");
            ALOGE(" [POWERON] DEBUG: Tries count: %d", retries);
            tfa_status_log(tfa_dev);
            tfa_dev->enabled = true;
            goto clck_end;
        }
        ALOGI(" [POWERON] Amplifier enabled [OK]: %d retries", retries);
    }
    else
    {
        //disable amp code

        //status: read d05f
        tfa_status_read(tfa_dev);
        ALOGI(" [STATUS] Current TFA status is: 0x%02X%02X", tfa_dev->status.flag[0], tfa_dev->status.flag[1]);

        //ctrl: read 027c
        tfa_control_read(tfa_dev);
        ALOGI(" [CONTROL] Current TFA control reg is: 0x%02X%02X", tfa_dev->control.flag[0], tfa_dev->control.flag[1]);

        //ctrl: 027Ñ->0264 (disable boost/amp)
        tfa_dev->control.flag_enable_boost = false;
        tfa_dev->control.flag_enable_amp = false;
        tfa_control_set(tfa_dev);
        ALOGI(" [CONTROL] Disabled Amplifier");

        //status: (wait) d05f->c05f
        int retries = 0;
        ALOGI(" [POWERDOWN] Waiting for stop amplifier...");
        do {
            tfa_status_read(tfa_dev);
            usleep(10000); //0.01s
            ++retries;
        } while (tfa_dev->status.flag_sws && retries<=200);

        if (retries>200) {
            ALOGE(" [POWERDOWN] Timeout waiting for stop amplifier!");
            ALOGE(" [POWERDOWN] DEBUG: Tries count: %d", retries);
            tfa_status_log(tfa_dev);
            goto clck_end;
        }
        ALOGI(" [POWERDOWN] Amplifier disabled [OK]: %d retries", retries);

        //ctrl: 0264->0265 (powerdown)
        tfa_dev->control.flag_powerdown = true;
        tfa_control_set(tfa_dev);
        ALOGI(" [CONTROL] Disabled TFA");

        //i2s: (disable) 889b->809b
        i2c_write(tfa_dev, (unsigned char []){0x04, 0x80, 0x9b}, 2);        
        ALOGI(" [I2S] Disabled I2S");

        //status: (just show) c05f->001d
        usleep(10000); //0.01s
        tfa_status_read(tfa_dev);
        ALOGI(" [STATUS] Current TFA status is: 0x%02X%02X", tfa_dev->status.flag[0], tfa_dev->status.flag[1]);
        
    }
    
    ALOGV("%s: Amplifier device %s", __func__, on ? "enabled" : "disabled");
    tfa_dev->enabled = on;

clck_end:
    tfa_clock_off(tfa_dev);

pwr_end:
    pthread_mutex_unlock(&tfa_dev->tfa_lock);

    return 0;
}

tfa_device_t * tfa_device_open() {
    tfa_device_t *tfa_dev;
    int rc;

    ALOGV("Opening amplifier device");

    tfa_dev = (tfa_device_t *) malloc(sizeof(tfa_device_t));
    if (tfa_dev == NULL) {
        ALOGE("%s: Not enough memory to load the tfa handle", __func__);
        return NULL;
    }
    
    rc = (tfa_dev->fd = open(TFA_DEV, O_RDWR));
    if (rc < 0) {
        ALOGE("failed to open %s: %s", TFA_DEV, strerror(-rc));
        return NULL;
    }

    if ((tfa_dev->mixer = mixer_open(SND_CARD)) == NULL) {
        ALOGE("failed to open mixer");
        return NULL;
    }

    tfa_dev->clock_enabled = false;
    tfa_dev->enabled = false;

    tfa_clock_on(tfa_dev);
    
    tfa_status_read(tfa_dev);
    tfa_status_log(tfa_dev);

    if (!tfa_coldboot(tfa_dev))
        tfa_dev->enabled = true;

    tfa_control_read(tfa_dev);
    tfa_control_log(tfa_dev);

    tfa_status_read(tfa_dev);
    tfa_status_log(tfa_dev);

    //tfa_write_preset(mode from enum) //spk_lo=0, spk_hi, voice_nb//

    //+struct volume (unsigned char level, bool mute(0x20), unsigned char ns)
    //tfa_api_volume_read
    //tfa_api_volume_set(int level)
    //tfa_api_mute_set(bool on)

    tfa_clock_off(tfa_dev);

    pthread_mutex_init(&tfa_dev->tfa_lock, (const pthread_mutexattr_t *) NULL);

    tfa_power(tfa_dev, false);

    return tfa_dev;
}

void tfa_device_close(tfa_device_t *tfa_dev) {
    ALOGV("%s: Closing amplifier device", __func__);
    tfa_power(tfa_dev, false);

    pthread_mutex_destroy(&tfa_dev->tfa_lock);

    if (tfa_dev) {
        free(tfa_dev);
    }
}
